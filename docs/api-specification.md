# Chimera D1 CMS - API Specification

**Version**: 1.0.0
**Last Updated**: October 12, 2025
**Status**: Foundation Release

## Overview

A content management system built on Payload CMS v3.x, deployed on Cloudflare Workers with D1 database and R2 storage. This is the foundation implementation that will be expanded with features from the payload-d1 webcomic CMS.

## Base URLs

- **Local Development**: `http://localhost:3333`
- **Workers Preview**: `http://localhost:50834` (varies per session)
- **Production**: TBD (your Cloudflare Workers deployment URL)

**Note**: All Payload CMS endpoints use the `/api/*` prefix.

## CORS Configuration

The API is configured to accept requests from the following origins:
- `http://localhost:8888` - Frontend development server
- `http://localhost:3333` - API development server
- `http://localhost:3000` - Default Next.js port (fallback)

CSRF protection is also enabled for these origins.

## Infrastructure

- **Database**: Cloudflare D1 (SQLite, edge-replicated)
- **Storage**: Cloudflare R2 (S3-compatible object storage)
- **Hosting**: Cloudflare Workers (serverless edge functions)
- **ID Format**: TEXT-based UUIDs (see UUID Workaround section)

## Authentication

### Endpoints

- `POST /api/users/login` - Login with email/password
- `POST /api/users/logout` - Logout current user
- `GET /api/users/me` - Get current user information
- `POST /api/users/forgot-password` - Request password reset
- `POST /api/users/reset-password` - Reset password with token

### Request/Response Examples

```json
// Login Request
POST /api/users/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "your-password"
}

// Login Response (200 OK)
{
  "message": "Logged in successfully",
  "user": {
    "id": 1,  // Default integer ID (UUID support pending)
    "email": "admin@example.com",
    "createdAt": "2025-10-12T00:00:00.000Z",
    "updatedAt": "2025-10-12T00:00:00.000Z"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "exp": 1728950400
}

// Get Current User
GET /api/users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

// Response (200 OK)
{
  "user": {
    "id": 1,
    "email": "admin@example.com",
    "collection": "users",
    "createdAt": "2025-10-12T00:00:00.000Z",
    "updatedAt": "2025-10-12T00:00:00.000Z"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "exp": 1728950400
}
```

### Authentication Flow

1. **Login**: POST credentials to `/api/users/login`
2. **Receive JWT**: Store the `token` from response
3. **Authenticate Requests**: Include token in Authorization header: `Bearer <token>`
4. **Token Expiration**: Tokens expire after 7 days (default Payload CMS behavior)

## Collections & Endpoints

### Users (`/users`)

Basic user authentication and management.

#### Endpoints

- `GET /api/users` - List users (admin only)
- `GET /api/users/:id` - Get specific user (admin only)
- `GET /api/users/me` - Get current user profile
- `PATCH /api/users/me` - Update own profile
- `PATCH /api/users/:id` - Update user (admin only)
- `DELETE /api/users/:id` - Delete user (admin only)

#### Data Structure

```json
{
  "id": 1,
  "email": "user@example.com",
  "createdAt": "2025-10-12T00:00:00.000Z",
  "updatedAt": "2025-10-12T00:00:00.000Z"
}
```

**Default Fields** (provided by Payload's `auth: true`):
- `id` - Integer (default) or TEXT UUID (when custom ID added)
- `email` - String, unique, required
- `password` - String, required (never returned in responses)
- `createdAt` - ISO 8601 datetime
- `updatedAt` - ISO 8601 datetime

**Access Control**:
- Anyone can read user data (currently)
- Only admins can create, update, or delete users
- Users can update their own profile via `/me` endpoint

### Media (`/media`)

File upload and management with R2 storage.

#### Endpoints

- `GET /api/media` - List media files
- `POST /api/media` - Upload new file
- `GET /api/media/:id` - Get specific media details
- `PATCH /api/media/:id` - Update media metadata
- `DELETE /api/media/:id` - Delete file
- `GET /api/media/file/:filename` - Access media file directly

#### Upload Endpoint

```http
POST /api/media
Content-Type: multipart/form-data
Authorization: Bearer <token>

Form Data:
  file: [binary file data]
  alt: "Description of the image"
  id: "550e8400-e29b-41d4-a716-446655440000"  // Optional UUID (API routes only)
```

**Important**: UUIDs must be generated by your API routes before calling Payload. See UUID Workaround section below.

#### Data Structure

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",  // UUID when provided via API
  "alt": "Description of the image",
  "filename": "example-image.jpg",
  "mimeType": "image/jpeg",
  "filesize": 245760,
  "width": 1920,
  "height": 1080,
  "url": "/api/media/file/example-image.jpg",
  "imageSizes": {
    "thumbnail": {
      "url": "/api/media/file/example-image-thumbnail.jpg",
      "width": 400,
      "height": 225,
      "mimeType": "image/jpeg",
      "fileSize": 15360,
      "filename": "example-image-thumbnail.jpg"
    },
    "thumbnail_small": { /* similar structure */ },
    "webcomic_page": { /* similar structure */ },
    "webcomic_mobile": { /* similar structure */ },
    "cover_image": { /* similar structure */ },
    "social_preview": { /* similar structure */ },
    "avatar": { /* similar structure */ }
  },
  "createdAt": "2025-10-12T10:30:00.000Z",
  "updatedAt": "2025-10-12T10:30:00.000Z"
}
```

**Fields**:
- `id` - TEXT (optional, provide UUID from API routes)
- `alt` - String, required, accessibility description
- `filename` - String (auto-generated), original filename
- `mimeType` - String (auto-detected)
- `filesize` - Integer (bytes)
- `width` - Integer (pixels, for images)
- `height` - Integer (pixels, for images)
- `url` - String, direct URL to access the file
- `imageSizes` - JSON object containing auto-generated thumbnails (7 sizes)
- `createdAt` - ISO 8601 datetime
- `updatedAt` - ISO 8601 datetime

**Image Sizes**: Automatically generated on upload (dev mode only, using Sharp):
- `thumbnail` - 400px width, inside fit
- `thumbnail_small` - 200px width, inside fit
- `webcomic_page` - 800px width, inside fit
- `webcomic_mobile` - 400px width, inside fit
- `cover_image` - 600×800px, cover fit
- `social_preview` - 1200×630px, cover fit
- `avatar` - 200×200px, cover fit

**Access Control**:
- Anyone can read media (currently)
- Authenticated users can upload, update, and delete

**File Storage**:
- Files stored in Cloudflare R2 bucket
- Local development uses R2 local mode
- Production uses Cloudflare R2 (edge-distributed)

## UUID Workaround (Important)

### Background

PayloadCMS hooks break in Cloudflare Workers during file upload operations. This prevents automatic UUID generation via `beforeValidate` or `beforeChange` hooks.

**See** `WORKAROUND-UUID.md` for full details.

### Current Implementation

**API Routes** (Primary Use Case):
Generate UUIDs in your API routes before calling Payload:

```typescript
// Example: Custom upload endpoint
import { getPayload } from 'payload'
import config from '@/payload.config'

export async function POST(req: Request) {
  const payload = await getPayload({ config })
  const formData = await req.formData()

  // Generate UUID manually
  const id = crypto.randomUUID()

  const media = await payload.create({
    collection: 'media',
    data: {
      id,  // Manually provided UUID
      file: formData.get('file'),
      alt: formData.get('alt') as string,
    },
  })

  return Response.json(media)
}
```

**Admin UI** (Emergency Fallback):
Currently uses Payload's default auto-increment IDs. Custom React component for UUID generation will be added in a future release once TypeScript compatibility is resolved.

**Database Configuration**:
```typescript
// src/payload.config.ts
db: sqliteD1Adapter({
  binding: cloudflare.env.D1,
  idType: 'text',  // TEXT columns for UUID support
  allowIDOnCreate: true,  // Allow manual ID specification
})
```

### Migration Plan

When PayloadCMS fixes the Workers hook bug:
1. Remove manual UUID generation from API routes
2. Add `beforeValidate` hooks back to collections
3. Remove `allowIDOnCreate` configuration (optional)

**Impact**: Zero database migration needed - existing UUIDs will continue to work.

## Common Query Patterns

### Filtering and Sorting

```javascript
// Get all media files, sorted by creation date
GET /api/media?sort=-createdAt

// Get specific media by ID
GET /api/media/550e8400-e29b-41d4-a716-446655440000

// Filter by field (example - when custom fields added)
GET /api/media?where[alt][contains]=logo
```

### Pagination

```javascript
// Standard pagination
GET /api/media?page=2&limit=20

// All endpoints support:
// - page: Page number (1-based, default: 1)
// - limit: Items per page (default: 10, max: 100)
```

### Population (Include Related Data)

```javascript
// Future use: When collections have relationships
GET /api/media/:id?depth=1

// depth parameter:
// depth=0: No relationships populated (IDs only) - default
// depth=1: Direct relationships populated
// depth=2: Nested relationships populated
```

## Error Responses

All endpoints return consistent error formats following Payload CMS conventions:

```json
// 400 Bad Request - Validation Error
{
  "errors": [
    {
      "message": "Field 'alt' is required",
      "field": "alt"
    }
  ]
}

// 401 Unauthorized
{
  "errors": [
    {
      "message": "You must be logged in to access this resource."
    }
  ]
}

// 403 Forbidden
{
  "errors": [
    {
      "message": "You are not allowed to perform this action."
    }
  ]
}

// 404 Not Found
{
  "errors": [
    {
      "message": "The requested resource was not found."
    }
  ]
}

// 500 Internal Server Error
{
  "errors": [
    {
      "message": "Something went wrong."
    }
  ]
}
```

## File Upload Details

### Supported File Types

Currently all file types are accepted. Recommended to add validation in custom API routes:
- Images: `image/jpeg`, `image/png`, `image/gif`, `image/webp`, `image/svg+xml`
- Documents: `application/pdf`
- Other: As needed

### Size Limits

- **Default Payload Limit**: 50MB per file
- **Cloudflare Workers Limit**: 100MB request body
- **Recommended**: Implement custom limits in API routes based on file type

### Storage Locations

**Local Development**:
- R2 uses local file simulation
- Files stored temporarily during development
- `.wrangler` directory contains local R2 data

**Production (Cloudflare Workers)**:
- Files stored in Cloudflare R2 bucket (configured in `wrangler.toml`)
- Edge-distributed for fast global access
- Automatic CDN integration

## Development Notes

### Local Development

```bash
# Start development server
pnpm dev

# Access points:
# - Application: http://localhost:3333
# - Admin UI: http://localhost:3333/admin
# - API Base: http://localhost:3333/api
```

### Workers Preview

```bash
# Build and preview in Workers environment
pnpm preview

# Access points:
# - Application: http://localhost:<random-port>
# - Admin UI: http://localhost:<random-port>/admin
# - API Base: http://localhost:<random-port>/api
```

### Database

- **Local Dev**: Uses Wrangler's simulated D1 (SQLite)
- **Production**: Cloudflare D1 (edge-replicated SQLite)
- **Migrations**: Automatic on startup
- **Schema**: Payload auto-generates from collections

**Important**: D1 has a 100-parameter limit per query (vs 999 for standard SQLite). This affects bulk operations and is why complex data should be stored in JSON fields.

### Authentication Tokens

- **Format**: JWT (JSON Web Tokens)
- **Storage**: Store in secure HTTP-only cookies or localStorage (for SPAs)
- **Expiration**: 7 days (Payload default)
- **Refresh**: No automatic refresh (re-login required after expiration)

## Frontend Implementation Tips

### Authentication Flow

```typescript
// 1. Login
const loginResponse = await fetch('/api/users/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password })
})
const { token, user } = await loginResponse.json()

// 2. Store token (example: localStorage for SPA)
localStorage.setItem('token', token)

// 3. Use token in subsequent requests
const mediaResponse = await fetch('/api/media', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
```

### File Upload

```typescript
// Upload file with UUID generation
const uploadFile = async (file: File, alt: string) => {
  const formData = new FormData()
  formData.append('file', file)
  formData.append('alt', alt)
  formData.append('id', crypto.randomUUID())  // Generate UUID client-side

  const response = await fetch('/api/media', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  })

  return response.json()
}
```

### Error Handling

```typescript
const handleAPIRequest = async (url: string, options: RequestInit) => {
  try {
    const response = await fetch(url, options)

    if (!response.ok) {
      const error = await response.json()
      // error.errors array contains detailed error information
      throw new Error(error.errors[0].message)
    }

    return await response.json()
  } catch (err) {
    console.error('API Error:', err)
    throw err
  }
}
```

## Security Considerations

### Current Implementation

- All media is publicly readable (no authentication required)
- Users collection requires admin access for most operations
- File uploads require authentication
- CORS is configured for:
  - `http://localhost:8888` - Frontend development server
  - `http://localhost:3333` - API development server
  - `http://localhost:3000` - Default Next.js port (fallback)
- CSRF protection enabled for the same origins

### Recommended Enhancements

When deploying to production:

1. **Add Access Control**: Implement role-based access control (RBAC)
2. **File Validation**: Validate file types and sizes in API routes
3. **Rate Limiting**: Implement rate limiting for API endpoints
4. **CORS Configuration**: Update CORS settings for production domains
5. **Environment Variables**: Use secure environment variables for secrets
6. **Content Security Policy**: Implement CSP headers

## Future Expansion

This API specification will be expanded as features are migrated from payload-d1:

### Planned Collections

- **Comics**: Webcomic series management
- **Chapters**: Organizational containers for pages
- **Pages**: Individual comic pages with images
- **Extended Users**: Role system (reader, creator, editor, admin)

### Planned Endpoints

- **Content Aggregation**: `GET /api/comic-with-chapters/:comicId`
- **Chapter Management**: `POST /api/move-chapter`, `POST /api/reorder-chapters`
- **Batch Operations**: `POST /bulk-create-pages`
- **Data Utilities**: `POST /recalculate-page-numbers`

### Planned Features

- Thumbnail generation (7 sizes per image)
- Page numbering system (chapter + global)
- Navigation helpers (previous/next page)
- Statistics tracking (views, engagement)
- SEO metadata support

**See**: `/Users/mike/Sites/payload-d1/docs/api-specification.md` for reference implementation.

## Version History

### v1.0.0 (October 12, 2025)
- Initial foundation release
- Users collection with basic authentication
- Media collection with R2 storage
- UUID workaround for Cloudflare Workers
- Comprehensive documentation

## Related Documentation

- **UUID Workaround**: `WORKAROUND-UUID.md` - Detailed explanation and migration plan
- **Bug Report**: `BUG-REPORT.md` - Root cause analysis of Workers hook issue
- **Implementation Summary**: `IMPLEMENTATION-SUMMARY.md` - Quick reference
- **Payload CMS Docs**: https://payloadcms.com/docs
- **Cloudflare D1**: https://developers.cloudflare.com/d1/
- **Cloudflare R2**: https://developers.cloudflare.com/r2/

## Support & Contributing

This is a foundation implementation that will evolve. When adding new features:

1. Update this API specification with new endpoints
2. Document data structures with examples
3. Add access control requirements
4. Include error scenarios
5. Update the version history

**Questions?** Refer to the comprehensive documentation in the root directory and `docs/` folder.
